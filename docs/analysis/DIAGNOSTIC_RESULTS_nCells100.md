# nCells=100診断結果

**実行日:** 2025-10-27
**設定:** moderate profile (1.5×, 1.2×), nCells=100, dt=1.5e-4, tolerance=5e-2

---

## 🔬 重要な発見

### 1. Jacobian条件数が15倍悪化 ⚠️

```
nCells=50:  κ = 4.2e+04,  σ_min = 8.40e+02
nCells=100: κ = 6.5e+05,  σ_min = 5.46e+01
```

**メッシュを細かくすると条件数が悪化！**
- σ_min が 15倍小さくなった
- より小さなスケールの変動が表現可能 → Jacobianの数値的安定性低下

---

### 2. 停滞は解消されたが、収束が極端に遅い ⚠️

#### residualNormの推移

| iter | nCells=50 | nCells=100 | 改善率 |
|------|-----------|------------|--------|
| 0 | 2.03 | 2.03 | - |
| 1 | 0.497 | 0.508 | - |
| 2 | 0.490 | 0.507 → 0.494 | +2.5% |
| 3 | **0.475** (停滞開始) | 0.468 | +5.2% |
| 4 | 0.475 | 0.466 | +0.5% |
| 5 | 0.475 | 0.463 | +0.6% |
| 6 | 0.475 | 0.463 | - |

**結果:**
- ✅ nCells=100では停滞せず、継続的に減少
- ❌ 収束速度が極端に遅い（1%未満/iter）
- ❌ 現在0.463（目標0.05の9.3倍）

**推定:** このペースでは、あと15-20イテレーション必要

---

### 3. Newton方向が過大 → αが極小値に 🔴

#### Line searchの詳細

| iter | α=1.0の結果 | 採用されたα | 改善率 |
|------|-------------|-------------|--------|
| 0 | +75.0% | 1.0 | +75.0% ✓ |
| 1 | -5.2% | 0.00195 | +0.2% |
| 2 | +2.5% | 1.0 | +2.5% ✓ |
| 3 | -20.4% | 0.25 | +5.2% |
| 4 | -21.3% | 0.0625 | +0.5% |
| 5 | -26.8% | 0.0625 | +0.6% |

**パターン:**
- iter=1以降、α=1.0では常に悪化（-5%から-27%）
- 採用されるαが 0.00195 ~ 0.25（極小）
- **Newton方向の大きさが不適切**（過大すぎる）

---

### 4. deltaScaledは健全だが、方向が不正確

```
nCells=50:  iter=3で2.88e-08（浮動小数点ノイズ）
nCells=100: iter=5で4.24e-07（10倍大きい）✓
```

**結果:**
- ✅ deltaScaledは消失していない
- ❌ しかし方向が不正確（α << 1が必要）

---

### 5. 計算時間の異常な増加 🔴

| iter | Jacobian計算時間 | vjp平均時間 |
|------|------------------|-------------|
| 0 | 21.1秒 | 0.053秒 |
| 1 | 22.2秒 | 0.056秒 |
| 2 | 21.1秒 | 0.056秒 |
| 3 | **93.9秒** | **0.235秒** (4.4倍！) |
| 4 | 89.9秒 | 0.230秒 |
| 5 | 89.7秒 | 0.210秒 |

**iter=3以降、vjp時間が4倍に増加（原因不明）**
- 推定総時間: 15イテレーション × 60秒 = **15分**
- まだ収束しないかもしれない

---

## 📊 nCells=50 vs nCells=100 比較

| 項目 | nCells=50 | nCells=100 | 評価 |
|------|-----------|------------|------|
| **停滞の有無** | あり（iter=3で固定） | なし（継続減少） | ✅ 改善 |
| **Jacobian条件数** | 4.2e+04 | 6.5e+05 | ❌ 15倍悪化 |
| **収束速度** | - | 1%/iter | ❌ 極端に遅い |
| **Line search α** | 0.1（固定） | 0.002-0.25 | ❌ 極小 |
| **計算時間/iter** | 10秒 | 20-90秒 | ❌ 2-9倍 |
| **推定総時間** | 2分（収束せず） | 15-20分（不明） | ❌ 長すぎる |

---

## 🎯 根本原因の特定

### メッシュ解像度のジレンマ

**粗いメッシュ（nCells=50）:**
- 離散化誤差が大きい（≈0.5）
- residualNormがこれ以下にならない
- **局所最小値に捕捉**

**細かいメッシュ（nCells=100）:**
- 離散化誤差は小さくなる
- しかしJacobian条件数が悪化（κ: 4e4 → 6.5e5）
- Newton方向が不正確になる
- **収束速度が極端に低下**

### Newton法の限界

**問題:**
1. Jacobianの条件数 > 10^5 でNewton法が効率的でなくなる
2. Line searchでα << 1が必要 = Newton方向を信頼できない
3. 1イテレーションあたりの改善が1%未満

**これはNewton法の適用範囲外です。**

---

## 💡 推奨する対策

### 🥇 最優先: Preconditioner導入

**目的:** Jacobianの条件数を改善（κ: 6.5e5 → 10^4程度）

**手法: Diagonal Preconditioner**
```swift
// Jacobian * P^{-1} * (P * Δx) = -R
// ここで P = diag(referenceState)
```

**実装:**
1. 物理変数ごとに異なるスケーリングを使用
2. Ti, Te: 1000 eV スケール
3. ne: 10^19 m^-3 スケール
4. psi: 別のスケール

**期待効果:**
- 条件数が1-2桁改善
- Newton方向が正確になる
- α=1.0で改善する可能性

---

### 🥈 次善策: Trust-Region法への切り替え

**Newton法の問題:**
- 遠方では二次近似が破綻
- Line searchで後付けで修正（非効率）

**Trust-Region法:**
```
min_{||Δ|| ≤ r} ||J·Δ + R||²
```
- 最初から信頼半径 r 内に制限
- より安定した収束

**実装の複雑さ:** 高（新しいソルバー実装）

---

### 🥉 代替策: nCells=75で妥協

**考え方:** 50と100の中間を試す

**期待される結果:**
- 条件数: κ ≈ 1-2e5（推定）
- 離散化誤差: ≈0.2-0.3（推定）
- tolerance=0.1に緩和すれば到達可能かも

**トレードオフ:**
- 物理的精度は犠牲になる
- しかし収束可能性が向上

---

## 📋 実装優先順位

1. **nCells=75を試す**（最も簡単）
   - 条件数と離散化誤差のバランスを取る
   - tolerance=0.1に緩和

2. **Preconditioner導入**（効果大、実装中程度）
   - 変数ごとのスケーリング改善
   - 条件数を根本的に改善

3. **Trust-Region法**（効果大、実装困難）
   - Newton法の根本的な置き換え
   - 長期的な解決策

---

## 🔍 現在の結論

**nCells=100への増強は部分的成功:**
- ✅ 停滞は解消
- ❌ 条件数悪化により収束が極端に遅い
- ❌ 計算時間が長すぎる（15分以上）
- ❌ tolerance=5e-2への到達は不確実

**メッシュ解像度だけでは解決できません。**

**次のステップ:**
1. まず nCells=75 + tolerance=1e-1 を試す（妥協案）
2. それでもダメなら Preconditioner の実装が必須

---

**最終更新:** 2025-10-27
**ステータス:** nCells=100は収束が遅すぎる、代替策が必要
