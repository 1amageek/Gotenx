# Newton-Raphson停滞の診断結果

**実行日:** 2025-10-27
**設定:** moderate profile (Ti/Te 1.5×, ne 1.2×), dt=3e-4, tolerance=5e-2, nCells=50

---

## 🔬 重要な発見

### 1. Jacobianの条件数は**良好** ✅

```
iter=0: κ = 4.21e+04
iter=1: κ = 4.21e+04
iter=2: κ = 4.20e+04
iter=3-7: κ = 4.19e+04
```

**特異値:**
- σ_max = 3.52e+07
- σ_min = 8.40e+02

**結論:**
- **κ < 10^5 → Jacobianは数値的に健全**
- **特異ではない（σ_min > 10^2）**
- **以前の仮説（Jacobian特異）は誤り**

---

### 2. Line Searchの詳細な挙動

#### iter=0 (成功)
```
α=1.000, residualNorm=4.97e-01, improvement=75.5%
✅ Accepted
```

#### iter=1 (わずかに改善)
```
α=1.000 → 5.01e-01 (-0.8%)  悪化
α=0.500 → 5.10e-01 (-2.5%)  さらに悪化
α=0.250 → 4.90e-01 (+1.4%)  わずかに改善 ✅
```

#### iter=2 (最後の改善)
```
α=1.000 → 4.75e-01 (+3.1%) ✅
residualNorm = 4.75e-01 へ到達
```

#### iter=3-7 (完全停滞)
```
α=1.000 → 5.44e-01 (-14.5%)  大幅悪化
α=0.500 → 4.75e-01 (±0.0%)   変化なし
α=0.250-0.002 → 4.75e-01 (±0.0%)  完全に固定
❌ FAILED: どのαでも改善不可
```

---

### 3. deltaScaledの推移（Newton補正ベクトル）

```
iter=0: ||Δ|| = 4.35e-04  ✓ 正常
iter=1: ||Δ|| = 3.26e-06  ⚠️  100倍減少
iter=2: ||Δ|| = 2.44e-06
iter=3: ||Δ|| = 2.88e-08  🔴 浮動小数点ノイズレベル
iter=4-7: ||Δ|| = 2.88e-08  🔴 完全固定
```

**iter=3で||Δ||が10^-8レベルに落ちる = Newton方向が消失**

---

### 4. F total（空間演算子）の推移

```
iter=0: [-1.96e+22, 1.25e+22]  (初期状態)
iter=1: [-8.42e+22, -1.35e+22]  (変化)
iter=2: [-8.42e+22, -1.35e+22]  (ほぼ同一)
iter=3-7: [-7.97e+22, -1.64e+22]  (完全固定)
```

**iter=3以降、物理状態が変化していない**

---

## 📊 根本原因の特定

### Jacobian条件数は良好なのに停滞 → 何が問題か？

**従来の仮説（誤り）:**
- ❌ Jacobianが特異（条件数 > 10^8）
- ❌ スケーリングが不適切

**診断結果（正しい）:**
- ✅ Jacobian自体は数値的に健全（κ=4.2e+04）
- ✅ 線形ソルバーは正しく解いている
- 🔴 **しかしNewton方向が局所最小値を指している**

### 局所最小値への捕捉

**residualNorm = 4.75e-01 で停滞**
- tolerance = 5e-2 の **9.5倍**
- 目標に到達できていない

**しかし:**
- どのαを試しても改善しない
- α=1.0: 悪化（-14.5%）
- α<1.0: 変化なし（±0.0%）

→ **Newton法の二次近似の範囲では、これ以上改善できない状態**

---

## 🎯 原因: 離散化誤差 vs 収束目標

### 仮説: メッシュ解像度不足

**現状:**
- nCells = 50
- dr = 2.0m / 50 = **0.04m (4cm)**

**moderate profile (1.5×, 1.2×) の勾配:**
- Ti: 1000 → 1500 eV over 2.0m
- dT/dr ≈ 250 eV/m

**1セルあたりの温度変化:**
- ΔT = 250 eV/m × 0.04m = **10 eV**

これは**50セルで500 eVの変化を表現**する必要があります。

**問題:**
- 勾配が急すぎて、50セルでは正確に表現できない
- 離散化誤差が residualNorm ≈ 0.5 のレベルに残る
- Newton法は離散化誤差以下には収束できない

---

## 💡 推奨する改善策

### 🥇 最優先: メッシュ解像度を増やす

```swift
builder.runtime.static.mesh.nCells = 100  // 50 → 100
```

**期待される効果:**
- dr = 2.0m / 100 = 0.02m (2cm)
- 1セルあたりの温度変化: ΔT = 5 eV
- 離散化誤差が約1/4に減少
- Newton法が residualNorm < 5e-2 へ収束可能に

**計算時間への影響:**
- Jacobian: 200×200 → 400×400 (4倍)
- vjp 200回 → 400回 (2倍)
- 推定: 10秒/iter → 40秒/iter

### 🥈 次善策: dtをさらに削減

```swift
builder.time.initialDt = 1.5e-4  // 3e-4 → 1.5e-4
```

**期待される効果:**
- 1ステップあたりの変化量が小さくなる
- 非線形性が緩和される
- Newton収束が改善

### 🥉 代替策: toleranceを緩和（最終手段）

```swift
tolerance: 1e-1  // 5e-2 → 1e-1
```

**効果:**
- residualNorm=4.75e-01で「収束」と判定される
- **しかし物理的精度は失われる**
- 診断用途のみ推奨

---

## 📋 推奨アクション

**以下の順で実装を推奨:**

1. **nCells=100に増やす**（最優先）
   - 離散化誤差を根本的に削減
   - 計算時間は増加するが、収束可能性が大幅向上

2. **dt=1.5e-4に削減**
   - 非線形性を緩和
   - 総ステップ数は2倍になるが、Newton収束は改善

3. **moderate profile維持**（1.5×, 1.2×）
   - Jacobian条件数は良好なので変更不要

4. **tolerance=5e-2維持**
   - メッシュ解像度向上後に再評価

---

## 🔍 検証項目

nCells=100実装後、以下を確認:

- [ ] iter=10までに residualNorm < 5e-2 到達
- [ ] deltaScaledが10^-8に落ちない（> 10^-6を維持）
- [ ] Line searchで改善が継続（improvement > 0%）
- [ ] Jacobian条件数が10^6未満を維持

---

**結論:** Jacobianの条件数問題ではなく、**メッシュ解像度不足による離散化誤差**が根本原因。nCells=100への増強を最優先で実装すべき。
